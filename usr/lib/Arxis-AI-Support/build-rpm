#!/bin/bash
# Stop script on errors
set -e

APP_NAME="arxis-ai-support"
APP_LIB_DIR="Arxis-AI-Support"

# Define source and build directories
EXEC_DIR=$(pwd)

# Calculate the parent directory two levels up
PARENT_X3_DIR=$(dirname "$(dirname "$(dirname "$EXEC_DIR")")")

# Define source and build directories
SOURCE_DIR=$EXEC_DIR
BUILD_DIR=$HOME/rpmbuild/BUILD/$APP_NAME
SPEC_DIR=$HOME/rpmbuild/SPECS
ZIP_DIR=$HOME/rpmbuild/SOURCES
BASH_SCRIPT="../../local/bin"
USRSOURCE="$PARENT_X3_DIR"
FUNCTIONS="$SOURCE_DIR/Functions.py"
SPEC_FILE="$SPEC_DIR/$APP_NAME.spec"

if [ ! -f "$SPEC_FILE" ]; then
    echo "Error: Spec file not found at $SPEC_FILE"
    exit 1
fi

# Read the current version
CURRENT_VERSION=$(grep -E '^Version:[[:space:]]*' "$SPEC_FILE" | awk '{print $2}')
if [ -z "$CURRENT_VERSION" ]; then
    echo "Error: Unable to find Version in spec file"
    exit 1
fi

# Ensure build directory exists
mkdir -p $BUILD_DIR

# Step 1: Update DEBUG variable in the Bash script
echo "Setting DEBUG to false in the Bash script..."
sed -i 's/^DEBUG=true/DEBUG=false/' $BASH_SCRIPT/$APP_NAME


# Increment the version
IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
MAJOR=${VERSION_PARTS[0]}
MINOR=${VERSION_PARTS[1]}
PATCH=$((VERSION_PARTS[2] + 1))
NEW_VERSION="$MAJOR.$MINOR.$PATCH"

# Update the version in the spec file
sed -i "s/^Version:.*$/Version: $NEW_VERSION/" "$SPEC_FILE"

echo "Version updated from $CURRENT_VERSION to $NEW_VERSION"

# Update version number in Functions.py
echo "Updating version number in Functions.py..."
sed -i "s/^Version[[:space:]]*=[[:space:]]*\".*\"/Version = \"$NEW_VERSION\"/" "$FUNCTIONS"

echo "Version updated to $NEW_VERSION in Functions.py"

# Load OPENAI_API_KEY from project root .env if present and export as ARXIS_API_KEY
PROJECT_ROOT="$(cd "$(dirname "$0")/../../.." && pwd)"
if [ -f "$PROJECT_ROOT/.env" ]; then
    # shellcheck disable=SC1090
    set -o allexport
    . "$PROJECT_ROOT/.env"
    set +o allexport
    export ARXIS_API_KEY="$OPENAI_API_KEY"
fi

# Extract the version number from the .spec file to confirm
VERSION=$(grep -E '^Version:[[:space:]]*' $SPEC_DIR/$APP_NAME.spec | awk '{print $2}')
echo "Confirmed version in spec file: $VERSION"

# Extract the version number from Functions.py to confirm
FUNC_VERSION=$(grep -E '^Version[[:space:]]*=' "$FUNCTIONS" | cut -d'"' -f2)
echo "Confirmed version in Functions.py: $FUNC_VERSION"

# Step 2: Compress the PROJECT-ROOT/usr directory
echo "Compressing the $USRSOURCE/usr directory..."
if [ -d "$USRSOURCE/usr" ]; then
    # Sync to ensure all pending disk writes are completed
    sync

    # Create a temporary copy of the directory
    TMP_DIR=$(mktemp -d)
    cp -R "$USRSOURCE/usr" "$TMP_DIR/"

    # Use the temporary copy for tarring, with the --warning=no-file-changed option
    tar --warning=no-file-changed -czf $APP_NAME-$VERSION.tar.gz -C "$TMP_DIR" usr

    # Remove the temporary directory
    rm -rf "$TMP_DIR"
else
    echo "Error: Directory $USRSOURCE/usr does not exist."
    exit 1
fi

# If ARXIS_API_KEY was exported earlier, embed an /etc env file into the tarball contents
if [ -n "$ARXIS_API_KEY" ]; then
    echo "Embedding API key into RPM payload (sensitive)"
    TMP_ETC_DIR=$(mktemp -d)
    mkdir -p "$TMP_ETC_DIR/etc/arxis-ai-support"
    printf '%s\n' "OPENAI_API_KEY=${ARXIS_API_KEY}" > "$TMP_ETC_DIR/etc/arxis-ai-support/env"
    chown root:root "$TMP_ETC_DIR/etc/arxis-ai-support/env" || true
    # Prefer making file group-readable by 'users' group to allow desktop access
    if getent group users >/dev/null 2>&1; then
        chgrp users "$TMP_ETC_DIR/etc/arxis-ai-support/env" || true
        chmod 0640 "$TMP_ETC_DIR/etc/arxis-ai-support/env" || true
        echo "Note: embedded env file will be root:users 0640 in the RPM payload"
    else
        # No 'users' group; fall back to world-readable but warn
        chmod 0644 "$TMP_ETC_DIR/etc/arxis-ai-support/env" || true
        echo "Warning: embedded env file will be world-readable (0644) because group 'users' not found"
    fi
    # Merge this into the tar used for SOURCES
    tar --append -f $APP_NAME-$VERSION.tar.gz -C "$TMP_ETC_DIR" etc || true
    rm -rf "$TMP_ETC_DIR"
fi

# Step 3: Copy the .tar.gz to ZIP_DIR
echo "Copying the .tar.gz to ZIP_DIR..."
cp $APP_NAME-$VERSION.tar.gz $ZIP_DIR/

rm $APP_NAME-$VERSION.tar.gz

# Step 4: Copy built executable and other files to RPM build directory
echo "Copying files to RPM build directory..."
cp -a ../../share/applications/arxis-ai-support.desktop $BUILD_DIR/ || echo "No .desktop file found to copy."
cp -a ../../share/pixmaps/arxis.png $BUILD_DIR/ || echo "No image found to copy."
cp -a ../../local/bin/$APP_NAME $BUILD_DIR/ || echo "No local binaries found to copy."
# cp -aR Settings $BUILD_DIR/ || echo "No Data directory found to copy."
cp -a *.py $BUILD_DIR/ || echo "No python files found to copy."

# Also include an env.sample for administrators to see how to create a user config
mkdir -p $BUILD_DIR/etc/arxis-ai-support || true
cat > $BUILD_DIR/etc/arxis-ai-support/env.sample <<'_SAMPLE_'
# Example environment file for Arxis AI Support
# Create /etc/arxis-ai-support/env with the line below and set permissions to 600
# OPENAI_API_KEY=your_api_key_here
_SAMPLE_
chmod 0644 $BUILD_DIR/etc/arxis-ai-support/env.sample || true

# Step 5: Build the RPM package
echo "Building RPM package..."
rpmbuild -ba $SPEC_DIR/$APP_NAME.spec

echo "Build completed successfully!"